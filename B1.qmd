---
title: "Bloque 1"
subtitle: |
    | Exploraci칩n de los datos ENSSEX. 
    | Primer congreso chileno de estudios interdisciplinarios sobre diversidad sexual y de g칠nero"
author: 
- name: Jos칠 Daniel Conejeros
  email: jdconejeros@uc.cl
  corresponding: true
  affiliations: Pontificia Universidad Cat칩lica de Chile
- name: Javiera Porcel
  email: jfporcel@uc.cl
  corresponding: true
date: today
date-format: long
title-block-banner: true
format: 
  html:
    #css: "files/style.css"
    #page-layout: full
    embed-resources: true
    smooth-scroll: true
    fontcolor: black
    toc: true
    toc-location: left
    toc-title: Indice
    code-copy: true
    code-link: true
    code-fold: show
    code-tools: true
    code-summary: "Click para ver el c칩digo"
    anchor-sections: true
    code-overflow: wrap
    fig-cap-location: top
lang: es
abstract-title: ""
abstract: "[Accede a todos los c칩digos dando click aqu칤.](https://github.com/JDConejeros/ENSSEX_WKS25)"
---

## 쯈u칠 haremos en este bloque? 

En este bloque nos enfocaremos en comprender la estructura, metodolog칤a y contenido de la ENSSEX. Exploraremos desde los objetivos y el dise침o metodol칩gico de la encuesta hasta la forma de explorar, manipular y analizar sus datos utilizando herramientas estad칤sticas. 

## 쮺칩mo se construyo la Encuesta Nacioanl de Salud, Sexualidad y G칠nero 2022 - 2023?

La Encuesta Nacional de Salud, Sexualidad y G칠nero (ENSSEX) 2022-2023, fue realizada por el Ministerio de Salud y coordinada por el Departamento de Epidemiolog칤a, en alianza con la Universidad de Chile, Universidad Alberto Hurtado e Instituto de Estudios Demogr치ficos de Par칤s, Francia. La Direcci칩n de Estudios Sociales (DESUC) de la Universidad Cat칩lica de Chile fue la instituci칩n a cargo del trabajo de campo. 

### Prop칩sito y alcance de la encuesta 

El objetivo de la ENSSEX es conocer las caracter칤sticas de salud sexual de la poblaci칩n de 18 a침os y m치s, con el fin de producir evidencia para el dise침o y evaluaci칩n de pol칤ticas p칰blicas.

La ENSSEX aborda tem치ticas relacionadas con la **salud sexual y reproductiva, pr치cticas sexuales, conductas de riesgo y percepciones sobre la sexualidad y g칠nero**. 

### Proceso de construcci칩n de datos

La encuesta se aplic칩 de agosto a diciembre del a침o 2022, entrevist칩 a 20.932 individuos en las 16 regiones del pa칤s. La ENSSEX es representativa a nivel nacional, por sexo, edad y regional. 

![](images/enssex_process.png){fig-align="center" width="900" .lightbox}

### Dise침o metodol칩gico

La ENSSEX se realiz칩 a trav칠s de un cuestionario aplicado por encuestadores en tablet, sobre un universo que incluy칩 a personas mayores de 18 a침os en la zona urbana de las regiones de todo Chile.

![](images/design.png){fig-align="center" width="900" .lightbox}

Para m치s detalle puede revisar el [游늯 manual de uso de base de datos y libro de c칩digos](https://epi.minsal.cl/wp-content/uploads/2024/05/MINSAL_ENSSEX_2022_2023_Manual_de_Uso_y_libro_de_codigos.pdf).

::: {.cell}
<iframe 
    src="https://epi.minsal.cl/bases-de-datos/"
    width="100%" 
    height="600px" 
    style="border: 1px solid #ccc;">
</iframe>
:::


## Exploraci칩n inicial de la ENSSEX

### Librer칤as a utilizar

Para el an치lisis de los datos de la ENSSEX en R, se pueden utilizar las siguientes librer칤as:

```{r}
#| warning: false
#| message: false
#| echo: true
#| results: hide

# Para instalar manualmente 
install.packages("tidyverse")
install.packages("rio")
install.packages("haven")
install.packages("janitor")
install.packages("labelled")
install.packages("naniar")
install.packages("sjPlot")

# Cargamos las librer칤as de trabajo 
library("tidyverse")
library("rio")
library("haven")
library("janitor")
library("labelled")
library("naniar")
library("sjPlot")
```

### 쯀mportar, cargar o abrir los datos?

Dependiendo del formato de los datos proporcionados (por ejemplo, SPSS, CSV, STATA), se utilizar치n funciones espec칤ficas para su importaci칩n en R. Una forma general de abrir los datos es con la funci칩n `rio::import()`

```{r}
#| warning: false
#| message: false
#| echo: true
?rio::import()
```

::: {.cell}
<iframe 
    src="https://cran.r-project.org/web/packages/rio/vignettes/rio.html"
    width="100%" 
    height="600px" 
    style="border: 1px solid #ccc;">
</iframe>
:::

```{r}
#| warning: false
#| message: false
#| echo: true
#| eval: false
# Hay varios caminos para abrir los datos dependiendo el formato:
data <- rio::import("20240516_ENSSEX_data.dta") # STATA
data <- rio::import("20240516_enssex_data.sav") # SPSS
data <- rio::import("20240516_ENSSEX_data.csv") # CSV
data <- rio::import("20240516_enssex_data.rdata") # R
```

```{r}
# Tambi칠n podemos descargar los datos directamente desde el repositorio on-line.
data <- rio::import("https://datos.gob.cl/dataset/c6983439-49f6-4e71-85fe-e8de6e73dae0/resource/ed81f50c-1c7d-43d9-9083-dfc161e0cd66/download/20240516_enssex_data.rdata")

# "data" es solo una manera de nombrar el objeto en R
```

### Estructura general de datos

La base de datos de la ENSSEX contiene 1123 variables y 20.392 observaciones. Las variables abarcan desde datos sociodemogr치ficos hasta respuestas espec칤ficas sobre salud y sexualidad. Hagamos una revi칩n general de la base de datos:


```{r}
#| warning: false
#| message: false
#| echo: true
dim(data) # Dimensiones de los datos [filas, columnas]
```

::: {.cell .scroll-box}
```{r}
colnames(data) # Nombre de las columnas 
```
:::

::: {.cell .scroll-box}
```{r}
dplyr::glimpse(data) # Tipos de variables 
```
:::

### Variables, libro de c칩digos y manejo de etiquetas 

El libro de c칩digos proporciona detalles sobre cada variable, incluyendo su nombre, etiqueta, valores posibles y frecuencias. Es esencial revisar este documento para entender el significado de cada variable y sus categor칤as, lo que facilita el an치lisis y la interpretaci칩n de los datos.

Para m치s detalle puede revisar el [游늯 manual de uso de base de datos y libro de c칩digos](https://epi.minsal.cl/wp-content/uploads/2024/05/MINSAL_ENSSEX_2022_2023_Manual_de_Uso_y_libro_de_codigos.pdf).

Revisemos el tipo de algunas variables: 

```{r}
#| warning: false
#| message: false
#| echo: true
# Exploremos la clase de variable 
class(data$region) # Region
typeof(data$region) 

class(data$comuna) # Comuna 
typeof(data$comuna) 

class(data$p4) # Edad
typeof(data$p4) 
```

Podemos chequear atributos de una variable:

```{r}
#| warning: false
#| message: false
#| echo: true
unique(data$region)
unique(data$comuna)
unique(data$p4)
```

Podemos chequear etiquetas de una variable: 

```{r}
#| warning: false
#| message: false
#| echo: true
# Revisamos los labels
haven::print_labels(data$region)
# Podemos remover etiquetas si es conveniente 
data$region_sin_labs <- haven::zap_labels(data$region)
unique(data$region_sin_labs)
```

Una mirada general: 

::: {.cell .scroll-box}
```{r}
#| warning: false
#| message: false
#| echo: true
sjPlot::view_df(data)
```
:::

### Validaci칩n de datos 

Evaluar casos duplicados: 

```{r}
#| warning: false
#| message: false
#| echo: true
# Podemos evaluar si hay duplicados con el folio de la encuesta 
table(duplicated(data$folio_encuesta))
table(data$folio_encuesta)[table(data$folio_encuesta) > 1]

# Otra manera de construir duplicados (dplyr)
data_sin_dup <- data |>
  # group_by(across(everything())) |>  # Consideramos todas las variables 
  group_by(folio_encuesta, folio_manzana) |> # Consideramos algunas variables
  mutate(duplicado = n() > 1) |> # Chequeamos si est치 duplicado
  filter(duplicado != TRUE) |> # Filtramos los duplicados
  ungroup()
```

Podemos verificar la consistencia y completitud de las variables:

```{r}
#| warning: false
#| message: false
#| echo: true
#| lightbox:
#|   group: r-graph
#|   description: Figura de missing values 
# Chequeamos missing values
naniar::vis_miss(data[, c("folio_encuesta", "macro_region", "region", "comuna",
                  "genero_separada", "orientacion_sexual_separado",
                  "edad", 
                  "relaciones_sexuales", 
                  "edad_primera_rsex", 
                  "lugar_primera_rsex", 
                  "vinculo_primera_rsex"
                  )])
```

Una librer칤a muy 칰til para el an치lisis de casos p칠rdidos es `naniar` (<https://naniar.njtierney.com/>).

Identificar y manejar valores at칤picos o inconsistentes:

```{r}
#| warning: false
#| message: false
#| echo: true
min(data$edad_primera_rsex, na.rm = TRUE) # M칤nimo
max(data$edad_primera_rsex, na.rm = TRUE) # M치ximo
summary(data$edad_primera_rsex) # Distribuci칩n
```

### An치lisis exploratorio 

```{r}
#| warning: false
#| message: false
#| echo: true
# Generamos algunas funciones
sum <- function(x, data){
  data |>
    dplyr::summarize(count=length(na.omit(!!sym(x))),
                     media=mean(!!sym(x), na.rm=TRUE),
                     sd=sd(!!sym(x), na.rm=TRUE),
                     min=min(!!sym(x), na.rm=TRUE),
                     q25=quantile(!!sym(x), na.rm=TRUE, probs=0.25),
                     q50=quantile(!!sym(x), na.rm=TRUE, probs=0.50),
                     q75=quantile(!!sym(x), na.rm=TRUE, probs=0.75),
                     max=max(!!sym(x), na.rm=TRUE))
}

tab <- function(x, data){
  data |>
    group_by(!!sym(x)) |>
    summarise(n=n()) |>
    ungroup() |>
    drop_na() |> 
    mutate(porcentaje=n/base::sum(n)*100)
}

# Exploramos para una variable num칠rica
sum(data = data, x = "edad_primera_rsex")
tab(data = data, x = "genero_separada")
```

**쯈u칠 podemos observar de estos an치lisis?**

## Ejercicio propuesto

Explore las siguientes preguntas del cuestionario y defina las acciones necesarias para el procesamiento de datos: 

![](images/p202.png){fig-align="center" width="900"}

Les recomiendo revisar el libro de c칩digos de la encuesta para tener una mejor comprensi칩n de la encuesta. 

![](images/banner.png){fig-align="center" width="900"}
